<!DOCTYPE html>
<html lang="it">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Simulatore Budget Stagionale | Gare dinamiche</title>
Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
Â  <style>
Â  Â  :root {
Â  Â  Â  color-scheme: light; 
Â  Â  Â  --bg:#f8fafc; /* Blu piÃ¹ chiaro */
Â  Â  Â  --surface:#fff; 
Â  Â  Â  --surface-alt:#f1f5f9; /* Sfondo leggermente grigio */
Â  Â  Â  --border:#e2e8f0; 
Â  Â  Â  --primary:#0f172a; /* Blu Scuro/Nero per contrasto */
Â  Â  Â  --primary-accent:#2563eb; /* Blu per CTA */
Â  Â  Â  --primary-accent-dark:#1d4ed8;
Â  Â  Â  --text:#0f172a; 
Â  Â  Â  --text-muted:#64748b; /* Grigio-Blu */
Â  Â  Â  --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 5px 15px rgba(0,0,0,0.05); /* Ombra morbida */
Â  Â  }
Â  Â  *{box-sizing:border-box}
Â  Â  body{margin:0;font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
Â  Â  header.hero{padding:64px 24px 40px;text-align:center;background:linear-gradient(180deg,rgba(37,99,235,.08),rgba(37,99,235,0))}
Â  Â  header.hero h1{margin:0;font-weight:800;font-size:clamp(2.5rem,4vw,3.5rem);line-height:1.1}
Â  Â  header.hero p{max-width:820px;margin:16px auto 0;color:var(--text-muted);font-size:1.1rem}
Â  Â  main{max-width:1400px;margin:0 auto;padding:0 24px 64px}
Â  Â  .layout-grid{display:grid;grid-template-columns:440px 1fr;align-items:start;gap:40px}

Â  Â  /* Stile card uniforme e moderno */
Â  Â  .panel,.card{
Â  Â  Â  background:var(--surface);
Â  Â  Â  border-radius:20px;
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  padding:28px;
Â  Â  Â  box-shadow:var(--shadow);
Â  Â  Â  overflow:hidden;
Â  Â  }
Â  Â  .panel h2,.card h2,.card h3{font-weight:700;color:var(--primary)}
Â  Â  .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:4px 0 16px}
Â  Â  .muted{color:var(--text-muted);font-size:.9rem}
Â  Â  
Â  Â  /* Stile Input */
Â  Â  label{display:flex;flex-direction:column;gap:6px;font-size:.9rem;color:var(--text-muted)}
Â  Â  label span{color:var(--text);font-weight:600}
Â  Â  input[type="number"],input[type="text"]{
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  border-radius:12px;
Â  Â  Â  padding:12px 14px;
Â  Â  Â  font-size:1rem;
Â  Â  Â  width:100%;
Â  Â  Â  transition:border-color .15s, box-shadow .15s;
Â  Â  }
Â  Â  input:focus{outline:none;border-color:var(--primary-accent);box-shadow:0 0 0 4px rgba(37,99,235,.2);}
Â  Â  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
Â  Â  .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-12{grid-column:span 12}
Â  Â  
Â  Â  /* Stile Bottoni */
Â  Â  .button-row{display:flex;flex-wrap:wrap;gap:12px}
Â  Â  button{
Â  Â  Â  border:none;
Â  Â  Â  border-radius:14px; /* Angoli meno arrotondati, piÃ¹ moderni */
Â  Â  Â  padding:12px 20px;
Â  Â  Â  font-weight:600;
Â  Â  Â  cursor:pointer;
Â  Â  Â  transition:transform .15s, background-color .15s, opacity .15s;
Â  Â  }
Â  Â  button:active{transform:scale(0.98);}
Â  Â  button.primary{background:var(--primary-accent);color:#fff;}
Â  Â  button.primary:hover{background:var(--primary-accent-dark);}
Â  Â  button.secondary{background:var(--surface-alt);border:1px solid var(--border);color:var(--text);}
Â  Â  button.secondary:hover{background:var(--border);}
Â  Â  button.ghost{background:transparent;border:1px dashed var(--border);color:var(--text-muted);}
Â  Â  button.ghost:hover{background:var(--surface-alt);}

Â  Â  /* Insight Cards */
Â  Â  .insight-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin:20px 0 8px}
Â  Â  .insight-card{
Â  Â  Â  background:var(--surface-alt);
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  border-radius:16px;
Â  Â  Â  padding:16px;
Â  Â  }
Â  Â  .insight-card h4{margin:0 0 4px;font-size:.85rem;color:var(--text-muted);font-weight:500;}
Â  Â  .insight-card p{margin:0;font-size:1.2rem;font-weight:700;color:var(--primary);}
Â  Â  .annualized{border-left:4px solid var(--primary-accent);background:rgba(37,99,235,.05);border-color:var(--primary-accent);}
Â  Â  
Â  Â  /* Tabelle */
Â  Â  .table-wrapper{border:1px solid var(--border);border-radius:18px;overflow-x:auto;}
Â  Â  table{width:100%;min-width:700px;border-collapse:separate;border-spacing:0;font-size:.95rem;}
Â  Â  thead th{
Â  Â  Â  text-align:left;
Â  Â  Â  padding:14px;
Â  Â  Â  font-size:.8rem;
Â  Â  Â  text-transform:uppercase;
Â  Â  Â  letter-spacing:.05em;
Â  Â  Â  color:var(--text-muted);
Â  Â  Â  border-bottom:1px solid var(--border);
Â  Â  Â  background:var(--surface-alt);
Â  Â  }
Â  Â  tbody td{padding:12px 14px;border-bottom:1px solid var(--border);}
Â  Â  tbody tr:last-child td{border-bottom:none;}
Â  Â  tfoot th{padding:14px;text-align:right;font-weight:700;border-top:2px solid var(--border);}
Â  Â  
Â  Â  /* Riepilogo Generale */
Â  Â  .summary-grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));margin:12px 0 28px}
Â  Â  .summary-box{
Â  Â  Â  padding:20px;
Â  Â  Â  background:var(--surface-alt);
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  border-radius:16px;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  }
Â  Â  .summary-box:hover{transform:translateY(-2px); box-shadow: var(--shadow);}
Â  Â  .summary-box h4{margin:0 0 10px;font-size:.9rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em}
Â  Â  .summary-box p{margin:0;font-size:1.5rem;font-weight:800;color:var(--primary-accent);}
Â  Â  .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:var(--surface-alt);padding:8px 14px;border-radius:12px;font-size:.9rem;font-weight:600;}
Â  Â  
Â  Â  /* Grafici */
Â  Â  .charts-grid{display:grid;gap:24px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));margin-top:28px}
Â  Â  .charts-grid .card{border:1px solid var(--border);border-radius:18px;padding:24px;box-shadow:none;}

Â  Â  /* Media Queries per responsive design */
Â  Â  @media (max-width:1100px){
Â  Â  Â  .layout-grid{grid-template-columns:1fr;gap:32px;}
Â  Â  Â  main{padding:0 16px 48px;}
Â  Â  Â  .panel,.card{padding:20px;}
Â  Â  Â  header.hero{padding:40px 16px 32px;}
Â  Â  Â  header.hero h1{font-size:2rem;}
Â  Â  Â  .row{gap:12px;}
Â  Â  Â  .col-3, .col-4, .col-6 {grid-column:span 6;} /* Su mobile, tutti gli input piccoli diventano 50% */
Â  Â  Â  .col-12 {grid-column:span 12;}
Â  Â  }
Â  Â  @media (max-width:600px) {
Â  Â  Â  .col-3, .col-4, .col-6 {grid-column:span 12;} /* Su mobile molto piccolo, tutti gli input a tutta larghezza */
Â  Â  }
Â  </style>
</head>
<body>
Â  <header class="hero">
Â  Â  <h1>Simulatore di Budget Stagionale</h1>
Â  Â  <p>Gestisci le <strong>gare</strong> una ad una (titolo, luogo, km, iscrizione, alloggio) e i <strong>costi fissi</strong> (leasing auto e abbigliamento). Calcolo, ripartizione e grafici aggiornati in tempo reale.</p>
Â  </header>

Â  <main>
Â  Â  <div class="layout-grid">
Â  Â  Â  <!-- SINISTRA: Parametri base + costi fissi + aggiunta gara -->
Â  Â  Â  <aside class="panel">
Â  Â  Â  Â  <div class="section-title">
Â  Â  Â  Â  Â  <h2 style="margin:0">Parametri & Costi</h2>
Â  Â  Â  Â  Â  <span class="tag" id="race-count-tag">0 gare</span>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Costi fissi -->
Â  Â  Â  Â  <section aria-labelledby="fixed-title">
Â  Â  Â  Â  Â  <div class="section-title"><h3 id="fixed-title" style="margin:0;font-size:1.1rem;font-weight:600;">Costi fissi (Annuali)</h3></div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <label class="col-6"><span>Leasing/Auto (â‚¬/mese)</span><input id="fixed-vehicle-month" type="number" min="0" step="10"></label>
Â  Â  Â  Â  Â  Â  <label class="col-6"><span>Abbigliamento (â‚¬/anno)</span><input id="fixed-clothing" type="number" min="0" step="50"></label>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="insight-grid">
Â  Â  Â  Â  Â  Â  <div class="insight-card annualized"><h4>Costo veicoli annuale</h4><p id="insight-annual-vehicle">â€“</p></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <hr style="border:none;border-top:1px dashed var(--border);margin:24px 0;">

Â  Â  Â  Â  <!-- Parametri dinamici -->
Â  Â  Â  Â  <section aria-labelledby="dynamic-title">
Â  Â  Â  Â  Â  <div class="section-title"><h3 id="dynamic-title" style="margin:0;font-size:1.1rem;font-weight:600;">Parametri viaggio</h3></div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <label class="col-4"><span>Carburante (â‚¬/L)</span><input id="fuel-price" type="number" min="0" step="0.01"></label>
Â  Â  Â  Â  Â  Â  <label class="col-4"><span>Consumo (L/100km)</span><input id="fuel-cons" type="number" min="0" step="0.1"></label>
Â  Â  Â  Â  Â  Â  <label class="col-4"><span>Pedaggi (â‚¬/km)</span><input id="toll-per-km" type="number" min="0" step="0.01"></label>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="insight-grid">
Â  Â  Â  Â  Â  Â  <div class="insight-card"><h4>Carburante al km</h4><p id="insight-fuel-km">â€“</p></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <hr style="border:none;border-top:1px dashed var(--border);margin:24px 0;">

Â  Â  Â  Â  <!-- Gare -->
Â  Â  Â  Â  <section aria-labelledby="race-title">
Â  Â  Â  Â  Â  <div class="section-title">
Â  Â  Â  Â  Â  Â  <h3 id="race-title" style="margin:0;font-size:1.1rem;font-weight:600;">Lista Gare</h3>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="button-row" style="margin-bottom:16px;">
Â  Â  Â  Â  Â  Â  <button type="button" id="btn-add-race" class="primary" aria-label="Aggiungi gara">+ Aggiungi Gara</button>
Â  Â  Â  Â  Â  Â  <button type="button" id="btn-fill-default" class="secondary" title="Carica 20 gare tipo">Autoriempi</button>
Â  Â  Â  Â  Â  Â  <button type="button" id="btn-clear-races" class="ghost" title="Rimuovi tutte le gare">Svuota Lista</button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <!-- Form inline -->
Â  Â  Â  Â  Â  <div class="row panel" style="margin-bottom:16px; padding:20px; border: 1px solid var(--primary-accent);" id="add-form" hidden>
                <div class="col-12" style="margin-bottom: 8px;"><h4 style="margin:0; font-weight:700; color:var(--primary-accent);">Dettagli Gara</h4></div>
Â  Â  Â  Â  Â  Â  <label class="col-6"><span>Titolo</span><input id="race-title-input" type="text" placeholder="Granfondo X"></label>
Â  Â  Â  Â  Â  Â  <label class="col-6"><span>Luogo</span><input id="race-place-input" type="text" placeholder="CittÃ , Prov."></label>
Â  Â  Â  Â  Â  Â  <label class="col-3"><span>Km viaggio (A/R)</span><input id="race-km-input" type="number" min="0" step="10" placeholder="400"></label>
Â  Â  Â  Â  Â  Â  <label class="col-3"><span>Iscrizione (â‚¬)</span><input id="race-reg-input" type="number" min="0" step="5" placeholder="60"></label>
Â  Â  Â  Â  Â  Â  <label class="col-3"><span>Alloggio (â‚¬)</span><input id="race-lodge-input" type="number" min="0" step="10" placeholder="150"></label>
Â  Â  Â  Â  Â  Â  <label class="col-3"><span>Giorni trasf.</span><input id="race-days-input" type="number" min="0" step="0.5" placeholder="1"></label>
Â  Â  Â  Â  Â  Â  <div class="col-12 button-row" style="margin-top:10px;">
Â  Â  Â  Â  Â  Â  Â  <button type="button" id="btn-save-race" class="primary">Salva Dati</button>
Â  Â  Â  Â  Â  Â  Â  <button type="button" id="btn-cancel-race" class="secondary">Annulla</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>#</th><th>Titolo</th><th>Luogo</th><th>Km (A/R)</th><th>Iscrizione</th><th>Alloggio</th><th>Giorni</th><th>Azioni</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  <tbody id="race-list"></tbody>
Â  Â  Â  Â  Â  Â  Â  <tfoot>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><th colspan="3" style="text-align:left;">Totale gare</th><th id="sum-km">â€“</th><th id="sum-reg">â€“</th><th id="sum-lodge">â€“</th><th id="sum-days">â€“</th><th></th></tr>
Â  Â  Â  Â  Â  Â  Â  </tfoot>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  Â  </aside>

Â  Â  Â  <!-- DESTRA: Risultati -->
Â  Â  Â  <section class="card">
Â  Â  Â  Â  <h2>Riepilogo Budget Stagionale</h2>
Â  Â  Â  Â  <div class="button-row" style="margin-bottom:20px;">
Â  Â  Â  Â  Â  <button id="btn-export-csv" class="secondary">ğŸ“„ Esporta CSV</button>
Â  Â  Â  Â  Â  <button id="btn-export-pdf" class="primary">ğŸ§¾ Esporta PDF</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="summary-grid">
Â  Â  Â  Â  Â  <div class="summary-box"><h4>Budget stagionale totale</h4><p id="season-total">â€“</p></div>
Â  Â  Â  Â  Â  <div class="summary-box"><h4>Spesa media per gara</h4><p id="race-cost">â€“</p></div>
Â  Â  Â  Â  Â  <div class="summary-box"><h4>Km totali viaggio</h4><p id="total-km">â€“</p></div>
Â  Â  Â  Â  Â  <div class="summary-box"><h4>Giornate in trasferta</h4><p id="total-travel-days">â€“</p></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <h3 style="margin-top:20px;">Dettaglio costi per voce</h3>
Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  <thead><tr><th>Voce di spesa</th><th>Categoria</th><th>Per gara (Media)</th><th>Stagione (Totale)</th></tr></thead>
Â  Â  Â  Â  Â  Â  <tbody id="detail-body"></tbody>
Â  Â  Â  Â  Â  Â  <tfoot><tr><th colspan="3" style="text-align:right;">Totale spese</th><th id="detail-total">â€“</th></tr></tfoot>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <div class="charts-grid">
Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <h3 style="margin-top:0;">Ripartizione percentuale</h3>
Â  Â  Â  Â  Â  Â  <canvas id="pie-chart" aria-label="Ripartizione costi" role="img"></canvas>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <h3 style="margin-top:0;">Costi per categoria</h3>
Â  Â  Â  Â  Â  Â  <canvas id="bar-chart" aria-label="Costi per categoria" role="img"></canvas>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>
Â  Â  </div>

Â  Â  <section class="card" style="margin-top:32px;">
Â  Â  Â  <h2>Metodologia di Calcolo</h2>
Â  Â  Â  <p class="muted">
Â  Â  Â  Â  Il calcolo del carburante Ã¨ basato sulla formula: 
Â  Â  Â  Â  <em>(Consumo per 100 km / 100) &times; Prezzo Carburante &times; Km viaggio totali</em>. 
Â  Â  Â  Â  I pedaggi sono calcolati come <em>â‚¬/km &times; Km viaggio totali</em>. 
Â  Â  Â  Â  I costi fissi (Leasing/Auto e Abbigliamento) sono annualizzati su 12 mesi e vengono ripartiti equamente sulla media di tutte le gare inserite.
Â  Â  Â  </p>
Â  Â  </section>
Â  </main>

Â  <footer style="text-align:center;padding:32px 16px 48px;color:var(--text-muted);font-size:.85rem;">Versione dimostrativa â€” Realizzato con â¤ï¸ e codice.</footer>

Â  <script>
Â  Â  // Variabile per il numero di mesi nell'anno per l'annualizzazione
Â  Â  const MONTHS = 12;

Â  Â  // Stato globale dell'applicazione
Â  Â  const state = {
Â  Â  Â  races: [], // {id,title,place,km,reg,lodge,days}
Â  Â  Â  fixed: { vehicleMonth: 550, clothingYear: 0 },
Â  Â  Â  params: { fuelPrice: 1.7, fuelCons100: 14, tollPerKm: 0.00 },
Â  Â  Â  charts: { pie:null, bar:null }
Â  Â  };

Â  Â  // ===== Utils
Â  Â  const qs = (s)=>document.querySelector(s);
Â  Â  const qsa = (s)=>[...document.querySelectorAll(s)];
Â  Â  // Formattazione valuta (â‚¬) - RINOMINATO PER EVITARE ERRORI DI SINTASSI CON CARATTERI UNICODE
Â  Â  const fmtCurrency = (v)=> new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(isFinite(v)?v:0);
Â  Â  // Formattazione numeri semplici
Â  Â  const fmt = (v)=> new Intl.NumberFormat('it-IT',{maximumFractionDigits:1}).format(isFinite(v)?v:0);
Â  Â  // Formattazione percentuale
Â  Â  const percent = (v,t)=> new Intl.NumberFormat('it-IT',{style:'percent',maximumFractionDigits:1}).format(t>0? v/t:0);
Â  Â  // Genera un ID univoco
Â  Â  const generateId = ()=> String(Date.now() + Math.floor(Math.random() * 1000)); 

Â  Â  // Calcola il costo del carburante per chilometro
Â  Â  function fuelPerKm(){ return (Number(state.params.fuelCons100)||0)/100 * (Number(state.params.fuelPrice)||0); }

Â  Â  // ===== Calcoli principali (il cuore del simulatore)
Â  Â  function recalc(){
Â  Â  Â  // Fissi (Annualizzati)
Â  Â  Â  const vehicleAnnual = (Number(state.fixed.vehicleMonth)||0) * MONTHS;
Â  Â  Â  const clothing = Number(state.fixed.clothingYear)||0;
Â  Â  Â  qs('#insight-annual-vehicle').textContent = fmtCurrency(vehicleAnnual);
Â  Â  Â  qs('#insight-fuel-km').textContent = fmtCurrency(fuelPerKm()) + ' / km';

Â  Â  Â  // Totali dalle gare
Â  Â  Â  const sumKm = state.races.reduce((s,r)=> s + (Number(r.km)||0), 0);
Â  Â  Â  const sumReg= state.races.reduce((s,r)=> s + (Number(r.reg)||0), 0);
Â  Â  Â  const sumLod= state.races.reduce((s,r)=> s + (Number(r.lodge)||0), 0);
Â  Â  Â  const sumDays= state.races.reduce((s,r)=> s + (Number(r.days)||0), 0);
Â  Â  Â  const raceCount = state.races.length;

Â  Â  Â  // Costi variabili (basati sui km)
Â  Â  Â  const fuelCost = fuelPerKm() * sumKm;
Â  Â  Â  const tollCost = (Number(state.params.tollPerKm)||0) * sumKm;
Â  Â  Â  
Â  Â  Â  // Totali finali
Â  Â  Â  const variableTotal = sumReg + sumLod + fuelCost + tollCost;
Â  Â  Â  const fixedTotal = vehicleAnnual + clothing;
Â  Â  Â  const seasonTotal = fixedTotal + variableTotal;

Â  Â  Â  // --- Aggiornamento Summary Box ---
Â  Â  Â  qs('#race-count-tag').textContent = raceCount + (raceCount === 1 ? ' gara' : ' gare');
Â  Â  Â  qs('#season-total').textContent = fmtCurrency(seasonTotal);
Â  Â  Â  // Costo medio per gara: (Costi Totali / Numero Gare)
Â  Â  Â  qs('#race-cost').textContent = fmtCurrency(raceCount ? seasonTotal/raceCount : seasonTotal);
Â  Â  Â  qs('#total-km').textContent = fmt(sumKm);
Â  Â  Â  qs('#total-travel-days').textContent = fmt(sumDays);

Â  Â  Â  // --- Tabella Dettaglio Costi ---
Â  Â  Â  const detail = [
Â  Â  Â  Â  // Fixed costs (Annual) divided by race count for 'perRace' average
Â  Â  Â  Â  {name:'Leasing/Auto (annuo)', cat:'Logistica', perRace: raceCount? vehicleAnnual/raceCount: vehicleAnnual, season: vehicleAnnual},
Â  Â  Â  Â  {name:'Abbigliamento (annuo)', cat:'Manutenzione', perRace: raceCount? clothing/raceCount: clothing, season: clothing},
Â  Â  Â  Â  // Variable costs (Total sum) divided by race count for 'perRace' average
Â  Â  Â  Â  {name:'Iscrizioni', cat:'Iscrizioni', perRace: raceCount? sumReg/raceCount: sumReg, season: sumReg},
Â  Â  Â  Â  {name:'Alloggio', cat:'Trasferte', perRace: raceCount? sumLod/raceCount: sumLod, season: sumLod},
Â  Â  Â  Â  {name:'Carburante', cat:'Trasferte', perRace: raceCount? fuelCost/raceCount: fuelCost, season: fuelCost},
Â  Â  Â  Â  {name:'Pedaggi', cat:'Trasferte', perRace: raceCount? tollCost/raceCount: tollCost, season: tollCost},
Â  Â  Â  ];
Â  Â  Â  
Â  Â  Â  const body = qs('#detail-body');
Â  Â  Â  if (body) {
Â  Â  Â  Â  body.innerHTML = '';
Â  Â  Â  Â  detail.forEach(d=>{
Â  Â  Â  Â  Â  // Se il costo stagionale Ã¨ zero, saltiamo la riga per pulizia
Â  Â  Â  Â  Â  if(d.season === 0 && d.name !== 'Leasing/Auto (annuo)') return; 
Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  tr.innerHTML = `<td>${d.name}</td><td>${d.cat}</td><td>${fmtCurrency(d.perRace)}</td><td>${fmtCurrency(d.season)}</td>`;
Â  Â  Â  Â  Â  body.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  qs('#detail-total').textContent = fmtCurrency(seasonTotal);

Â  Â  Â  // --- Totali in tabella gare ---
Â  Â  Â  qs('#sum-km').textContent = fmt(sumKm);
Â  Â  Â  qs('#sum-reg').textContent = fmtCurrency(sumReg);
Â  Â  Â  qs('#sum-lodge').textContent = fmtCurrency(sumLod);
Â  Â  Â  qs('#sum-days').textContent = fmt(sumDays);

Â  Â  Â  // Aggiornamento UI
Â  Â  Â  renderRaceTable();

Â  Â  Â  // --- Grafici ---
Â  Â  Â  // Aggregazione per categoria per il grafico a barre
Â  Â  Â  const categories = detail.reduce((acc, d) => {
Â  Â  Â  Â  acc[d.cat] = (acc[d.cat] || 0) + d.season;
Â  Â  Â  Â  return acc;
Â  Â  Â  }, {});
Â  Â  Â  
Â  Â  Â  updateCharts({ categories, total: seasonTotal });
Â  Â  }

Â  Â  function renderRaceTable(){
Â  Â  Â  const tbody = qs('#race-list');
Â  Â  Â  if (!tbody) return; 

Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  state.races.forEach((r,idx)=>{
Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  <td>${idx+1}</td>
Â  Â  Â  Â  Â  <td>${r.title||'-'}</td>
Â  Â  Â  Â  Â  <td>${r.place||'-'}</td>
Â  Â  Â  Â  Â  <td>${fmt(r.km)}</td>
Â  Â  Â  Â  Â  <td>${fmtCurrency(r.reg)}</td>
Â  Â  Â  Â  Â  <td>${fmtCurrency(r.lodge)}</td>
Â  Â  Â  Â  Â  <td>${fmt(r.days)}</td>
Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  <button type="button" class="secondary" style="padding: 8px 12px; border-radius: 8px; font-size: 0.85rem;" data-edit="${r.id}">Modifica</button>
Â  Â  Â  Â  Â  Â  <button type="button" class="ghost" style="padding: 8px 12px; border-radius: 8px; font-size: 0.85rem;" data-del="${r.id}">X</button>
Â  Â  Â  Â  Â  </td>`;
Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  });
Â  Â  Â  // Bindings per Modifica/Elimina
Â  Â  Â  qsa('[data-del]').forEach(b=> b.onclick = ()=>{ state.races = state.races.filter(x=> x.id!==b.dataset.del); recalc(); });
Â  Â  Â  qsa('[data-edit]').forEach(b=> b.onclick = ()=> startEditRace(b.dataset.edit));
Â  Â  }

Â  Â  // ===== Aggiungi/Modifica gara
Â  Â  let editingId = null;
Â  Â  function toggleAddForm(show){ 
        const form = qs('#add-form');
        if (form) form.hidden = !show; 
        const btnAdd = qs('#btn-add-race');
        if(btnAdd) btnAdd.disabled = show; // Disabilita il bottone Aggiungi mentre il form Ã¨ aperto
    }
Â  Â  function clearForm(){ 
        ['#race-title-input','#race-place-input','#race-km-input','#race-reg-input','#race-lodge-input','#race-days-input'].forEach(s=> {
            const el = qs(s);
            if (el) el.value='';
        }); 
        editingId=null; 
        if(qs('#btn-save-race')) qs('#btn-save-race').textContent = 'Salva Dati'; // Resetta testo bottone
    }
Â  Â  function startAddRace(){ clearForm(); toggleAddForm(true); const titleInput = qs('#race-title-input'); if(titleInput) titleInput.focus(); }
Â  Â  function startEditRace(id){
Â  Â  Â  const r = state.races.find(x=> x.id===id); if(!r) return;
Â  Â  Â  editingId = id;
Â  Â  Â  // Riempimento form con controlli di sicurezza
Â  Â  Â  if(qs('#race-title-input')) qs('#race-title-input').value = r.title||'';
Â  Â  Â  if(qs('#race-place-input')) qs('#race-place-input').value = r.place||'';
Â  Â  Â  if(qs('#race-km-input')) qs('#race-km-input').value = r.km||0;
Â  Â  Â  if(qs('#race-reg-input')) qs('#race-reg-input').value = r.reg||0;
Â  Â  Â  if(qs('#race-lodge-input')) qs('#race-lodge-input').value = r.lodge||0;
Â  Â  Â  if(qs('#race-days-input')) qs('#race-days-input').value = r.days||0;
Â  Â  Â  
Â  Â  Â  if(qs('#btn-save-race')) qs('#btn-save-race').textContent = 'Aggiorna Gara';
Â  Â  Â  toggleAddForm(true);
Â  Â  Â  const titleInput = qs('#race-title-input'); if(titleInput) titleInput.focus();
Â  Â  }
Â  Â  function saveRace(){
Â  Â  Â  // Aggiunto controllo null per tutti gli input prima di accedere a .value
Â  Â  Â  const title = (qs('#race-title-input')?.value||'').trim();
Â  Â  Â  const place = (qs('#race-place-input')?.value||'').trim();
Â  Â  Â  const km = Number(qs('#race-km-input')?.value)||0;
Â  Â  Â  const reg = Number(qs('#race-reg-input')?.value)||0;
Â  Â  Â  const lodge = Number(qs('#race-lodge-input')?.value)||0;
Â  Â  Â  const days = Number(qs('#race-days-input')?.value)||0;

Â  Â  Â  // Validazione minima
Â  Â  Â  if (title.length < 2) {
Â  Â  Â  Â  // Sostituisco alert() con un log console (o si potrebbe usare un modal personalizzato)
Â  Â  Â  Â  console.error("Per favore, inserisci un titolo valido per la gara.");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  if(editingId){
Â  Â  Â  Â  const i = state.races.findIndex(x=> x.id===editingId);
Â  Â  Â  Â  if(i>-1) state.races[i] = { ...state.races[i], title, place, km, reg, lodge, days };
Â  Â  Â  } else {
Â  Â  Â  Â  // Aggiungi nuova gara
Â  Â  Â  Â  const id = generateId(); 
Â  Â  Â  Â  state.races.push({ id, title, place, km, reg, lodge, days });
Â  Â  Â  }
Â  Â  Â  toggleAddForm(false); clearForm(); recalc();
Â  Â  }
Â  Â  
Â  Â  function fillDefaults(){
Â  Â  Â  state.races = Array.from({length:15}).map((_,i)=>({ 
          id: generateId(), 
          title:`Gara ${i+1} - ${i%3===0 ? 'Campionato' : 'Tappa'}`, 
          place: i%2===0 ? 'Milano, MI' : 'Roma, RM', 
          km: Math.floor(Math.random()*15+1)*100, // Variabile tra 100 e 1500
          reg: Math.floor(Math.random()*5+1)*20, // Variabile tra 20 e 100
          lodge: i%4===0 ? Math.floor(Math.random()*5+1)*50 : 0, // 1 su 4 ha alloggio
          days: i%4===0 ? Math.random() < 0.5 ? 1.5 : 2 : 1 // 1 o 1.5 o 2 giorni
      }));
      // Chiude form se aperto
      toggleAddForm(false); clearForm();
Â  Â  Â  recalc();
Â  Â  }
Â  Â  function clearRaces(){ state.races = []; recalc(); }

Â  Â  // ===== Grafici
Â  Â  const PIE_COLORS = ['#2563eb','#f97316','#14b8a6','#6366f1','#0f9d58','#9333ea','#ef4444'];
Â  Â  function updateCharts({categories,total}){
Â  Â  Â  const labels = Object.keys(categories).filter(k => categories[k] > 0);
Â  Â  Â  const values = labels.map(k=> categories[k]);
Â  Â  Â  
Â  Â  Â  const pieCtx = qs('#pie-chart');
Â  Â  Â  if(state.charts.pie && pieCtx) state.charts.pie.destroy();
      if(pieCtx){
        state.charts.pie = new Chart(pieCtx, {
Â  Â  Â  Â  type:'pie',
Â  Â  Â  Â  data:{ labels, datasets:[{ data: values, backgroundColor: labels.map((_,i)=> PIE_COLORS[i%PIE_COLORS.length]+"E0"), borderColor:'#fff', borderWidth:3 }] },
Â  Â  Â  Â  options:{ 
            responsive:true, 
            aspectRatio: 1, // Assicura un cerchio
            plugins:{ 
                legend:{ 
                    position:'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: { size: 13 }
                    }
                }, 
                tooltip:{ 
                    callbacks:{ 
                        label: (ctx)=> `${ctx.label}: ${fmtCurrency(ctx.parsed)} (${percent(ctx.parsed,total)})` 
                    } 
                } 
            } 
        }
Â  Â  Â  });
      }

Â  Â  Â  const barCtx = qs('#bar-chart');
Â  Â  Â  if(state.charts.bar && barCtx) state.charts.bar.destroy();
      if(barCtx) {
        state.charts.bar = new Chart(barCtx, {
Â  Â  Â  Â  type:'bar',
Â  Â  Â  Â  data:{ labels, datasets:[{ label:'Costo per categoria', data: values, backgroundColor: labels.map((_,i)=> PIE_COLORS[i%PIE_COLORS.length]+"CC"), borderRadius:8 }] },
Â  Â  Â  Â  options:{ 
            responsive:true, 
            aspectRatio: 1, // Alto quanto il grafico a torta
            plugins:{ 
                legend:{ display:false }, 
                tooltip:{ 
                    callbacks:{ label:(ctx)=> fmtCurrency(ctx.parsed.y) } 
                } 
            }, 
            scales:{ 
                y:{ 
                    beginAtZero:true, 
                    ticks:{ 
                        callback:(v)=> v > 0 ? fmtCurrency(v) : '' // Nasconde etichette 0
                    } 
                } 
            } 
        }
Â  Â  Â  });
      }
Â  Â  }

Â  Â  // ===== Esportazioni
Â  Â  function exportCSV(){
Â  Â  Â  // Intestazione CSV
Â  Â  Â  let csv = 'Titolo;Luogo;Km (A/R);Iscrizione (â‚¬);Alloggio (â‚¬);Giorni Trasferta\n';
Â  Â  Â  // Dati gare
Â  Â  Â  state.races.forEach(r=>{ csv += `${r.title};${r.place};${r.km};${r.reg};${r.lodge};${r.days}\n`; });
Â  Â  Â  // Dati parametri e totali
      csv += '\nCosti Fissi e Parametri\n';
      csv += `Leasing Mensile (â‚¬);${state.fixed.vehicleMonth}\n`;
      csv += `Abbigliamento Annuale (â‚¬);${state.fixed.clothingYear}\n`;
      csv += `Carburante (â‚¬/L);${state.params.fuelPrice}\n`;
      csv += `Consumo (L/100km);${state.params.fuelCons100}\n`;
      csv += `Pedaggi (â‚¬/km);${state.params.tollPerKm}\n`;
      csv += '\nTotali Stagione\n';
      csv += `Totale Spesa Stagione (â‚¬);${qs('#season-total')?.textContent.replace('â‚¬', '').trim().replace('.', '').replace(',', '.') || '0'}\n`;

Â  Â  Â  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  const a = document.createElement('a'); a.href=url; a.download='budget_stagionale.csv'; a.click(); URL.revokeObjectURL(url);
Â  Â  }

Â  Â  async function exportPDF(){
Â  Â  Â  // Verifica che jsPDF sia disponibile
      if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
          console.error("Libreria jsPDF non caricata.");
          return;
      }
Â  Â  Â  const { jsPDF } = window.jspdf; 
      const doc = new jsPDF({unit:'pt',format:'a4'});
Â  Â  Â  const W = doc.internal.pageSize.getWidth(); 
      let y = 40; 
      const pad=24; 
      const line=18;
      
Â  Â  Â  // Titolo e Riepilogo
Â  Â  Â  doc.setFont('Inter', 'bold');
Â  Â  Â  doc.setFontSize(22); doc.text('Riepilogo Budget Stagionale', pad, y); y+=line*1.5;

Â  Â  Â  doc.setFontSize(12); doc.setFont('Inter', 'normal');
Â  Â  Â  doc.text(`Totale stagione: ${qs('#season-total')?.textContent || '-'}`, pad, y); y+=14;
Â  Â  Â  doc.text(`Spesa media per gara: ${qs('#race-cost')?.textContent || '-'}`, pad, y); y+=14;
Â  Â  Â  doc.text(`Km totali: ${qs('#total-km')?.textContent || '-'} | Giorni trasferta: ${qs('#total-travel-days')?.textContent || '-'}`, pad, y); y+=line*1.5;

Â  Â  Â  // Dettaglio Costi
Â  Â  Â  doc.setFontSize(16); doc.setFont('Inter', 'bold'); doc.text('Dettaglio Costi', pad, y); y+=14;
      
      const detailTableData = [];
      qsa('#detail-body tr').forEach(row => {
          const cells = qsa('td', row).map(cell => cell.textContent);
          detailTableData.push(cells);
      });

      const detailTableHeaders = ['Voce di spesa', 'Categoria', 'Per gara (Media)', 'Stagione (Totale)'];
      
      doc.autoTable({
          startY: y,
          head: [detailTableHeaders],
          body: detailTableData,
          theme: 'grid',
          styles: { font: 'Inter', fontSize: 10, cellPadding: 6 },
          headStyles: { fillColor: '#e2e8f0', textColor: '#0f172a', fontStyle: 'bold' },
          foot: [['Totale spese', '', '', qs('#detail-total')?.textContent || '-']],
          footStyles: { fontStyle: 'bold', fillColor: '#f1f5f9' },
          margin: { left: pad, right: pad }
      });
      y = doc.autoTable.previous.finalY + line;

Â  Â  Â  // Dettaglio Gare
Â  Â  Â  doc.setFontSize(16); doc.setFont('Inter', 'bold'); doc.text('Lista Gare', pad, y); y+=14;

      const raceTableData = [];
      state.races.forEach((r,i) => {
          raceTableData.push([
              i + 1,
              r.title || '-',
              r.place || '-',
              fmt(r.km),
              r.reg + ' â‚¬',
              r.lodge + ' â‚¬',
              fmt(r.days)
          ]);
      });
      
      const raceTableHeaders = ['#', 'Titolo', 'Luogo', 'Km (A/R)', 'Iscrizione', 'Alloggio', 'Giorni'];
      
      doc.autoTable({
          startY: y,
          head: [raceTableHeaders],
          body: raceTableData,
          theme: 'grid',
          styles: { font: 'Inter', fontSize: 10, cellPadding: 6 },
          headStyles: { fillColor: '#e2e8f0', textColor: '#0f172a', fontStyle: 'bold' },
          margin: { left: pad, right: pad }
      });
      y = doc.autoTable.previous.finalY + line;

Â  Â  Â  // Grafici come immagini (se esistono)
Â  Â  Â  try{
Â  Â  Â  Â  const pie = document.getElementById('pie-chart');
Â  Â  Â  Â  const bar = document.getElementById('bar-chart');
Â  Â  Â  Â  if(pie && bar){
            // Assicurati che Chart.js abbia finito il rendering (ritardo minimo)
            await new Promise(r => setTimeout(r, 100)); 
            
Â  Â  Â  Â  Â  Â  const pieImg = pie.toDataURL('image/png',1.0);
Â  Â  Â  Â  Â  Â  const barImg = bar.toDataURL('image/png',1.0);
            
Â  Â  Â  Â  Â  Â  doc.addPage(); 
            y=40; 
            doc.setFontSize(16); doc.setFont('Inter', 'bold'); doc.text('Grafici di Ripartizione', pad, y); y+=20;
            
Â  Â  Â  Â  Â  Â  const imgW = W - pad*2; 
            const imgH = imgW * 0.42; // Mantiene l'aspect ratio
            
Â  Â  Â  Â  Â  Â  doc.addImage(pieImg,'PNG',pad,y,imgW,imgH); y+=imgH+20;
Â  Â  Â  Â  Â  Â  doc.addImage(barImg,'PNG',pad,y,imgW,imgH);
Â  Â  Â  Â  }
Â  Â  Â  }catch(e){ console.warn("Errore durante l'acquisizione dei grafici per il PDF:", e); }
Â  Â  Â  doc.save('budget_stagionale.pdf');
Â  Â  }

Â  Â  // Necessario per jsPDF autoTable
    // Aggiungi un placeholder per autoTable
    document.write('<script src="https://unpkg.com/jspdf-autotable@3.5.21/dist/jspdf.plugin.autotable.js"></script>');

Â  Â  // ===== Binding eventi e defaults
Â  Â  function bind(){
Â  Â  Â  // Funzione di utilitÃ  per il binding
        const bindInput = (id, propertyPath, isFixed = false) => {
            const input = qs(id);
            if (input) {
                input.addEventListener('input', e => {
                    const value = Number(e.target.value) || 0;
                    if (isFixed) {
                        state.fixed[propertyPath] = value;
                    } else { 
                        state.params[propertyPath] = value;
                    }
                    recalc();
                });
                // Aggiunge la classe di interazione CSS all'input
                input.classList.add('interactable-input');
            }
        };

Â  Â  Â  // fissi
Â  Â  Â  bindInput('#fixed-vehicle-month', 'vehicleMonth', true);
Â  Â  Â  bindInput('#fixed-clothing', 'clothingYear', true);
Â  Â  Â  // parametri
Â  Â  Â  bindInput('#fuel-price', 'fuelPrice');
Â  Â  Â  bindInput('#fuel-cons', 'fuelCons100');
Â  Â  Â  bindInput('#toll-per-km', 'tollPerKm');
Â  Â  Â  
Â  Â  Â  // gare
Â  Â  Â  if(qs('#btn-add-race')) qs('#btn-add-race').addEventListener('click', startAddRace);
Â  Â  Â  if(qs('#btn-fill-default')) qs('#btn-fill-default').addEventListener('click', fillDefaults);
Â  Â  Â  if(qs('#btn-clear-races')) qs('#btn-clear-races').addEventListener('click', clearRaces);
Â  Â  Â  if(qs('#btn-save-race')) qs('#btn-save-race').addEventListener('click', saveRace);
Â  Â  Â  if(qs('#btn-cancel-race')) qs('#btn-cancel-race').addEventListener('click', ()=> { toggleAddForm(false); clearForm(); });
Â  Â  Â  // export
Â  Â  Â  if(qs('#btn-export-csv')) qs('#btn-export-csv').addEventListener('click', exportCSV);
Â  Â  Â  if(qs('#btn-export-pdf')) qs('#btn-export-pdf').addEventListener('click', exportPDF);
Â  Â  }

Â  Â  // Imposta i valori di default iniziali (come se l'utente li avesse giÃ  scritti)
Â  Â  function setDefaults(){
Â  Â  Â  state.fixed.vehicleMonth = 550; 
Â  Â  Â  state.fixed.clothingYear = 0;Â  Â 
Â  Â  Â  state.params.fuelPrice = 1.7;
Â  Â  Â  state.params.fuelCons100 = 14;
Â  Â  Â  state.params.tollPerKm = 0.00; 
      
Â  Â  Â  if(qs('#fixed-vehicle-month')) qs('#fixed-vehicle-month').value = state.fixed.vehicleMonth;
Â  Â  Â  if(qs('#fixed-clothing')) qs('#fixed-clothing').value = state.fixed.clothingYear;
Â  Â  Â  if(qs('#fuel-price')) qs('#fuel-price').value = state.params.fuelPrice;
Â  Â  Â  if(qs('#fuel-cons')) qs('#fuel-cons').value = state.params.fuelCons100;
Â  Â  Â  if(qs('#toll-per-km')) qs('#toll-per-km').value = state.params.tollPerKm;
Â  Â  }

Â  Â  document.addEventListener('DOMContentLoaded', ()=>{ 
        setDefaults(); 
        bind(); 
        recalc(); 
    });
Â  </script>
</body>
</html>
