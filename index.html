import openpyxl
from openpyxl import Workbook
from openpyxl.styles import Font
import random

# Crea workbook
wb = Workbook()
wb.remove(wb.active)  # Rimuovi sheet default

# Sheet Inputs
ws_inputs = wb.create_sheet('Inputs')
ws_inputs['A1'] = 'Parametri & Costi'
ws_inputs['A1'].font = Font(bold=True, size=14)

ws_inputs['A3'] = 'Costi fissi (Annuali)'
ws_inputs['A3'].font = Font(bold=True)
ws_inputs['A4'] = 'Leasing/Auto (€/mese)'
ws_inputs['B4'] = 550
ws_inputs['A5'] = 'Abbigliamento (€/anno)'
ws_inputs['B5'] = 0

ws_inputs['A7'] = 'Parametri viaggio'
ws_inputs['A7'].font = Font(bold=True)
ws_inputs['A8'] = 'Carburante (€/L)'
ws_inputs['B8'] = 1.7
ws_inputs['A9'] = 'Consumo (L/100km)'
ws_inputs['B9'] = 14
ws_inputs['A10'] = 'Pedaggi (€/km)'
ws_inputs['B10'] = 0
ws_inputs['A11'] = 'Fattore correzione km stradali'
ws_inputs['B11'] = 1.2

# Sheet Gare
ws_races = wb.create_sheet('Gare')
ws_races['A1'] = 'Lista Gare'
ws_races['A1'].font = Font(bold=True, size=14)

headers = ['#', 'Titolo', 'Luogo', 'Km (A/R)', 'Iscrizione (€)', 'Alloggio (€)', 'Giorni trasf.']
for col, header in enumerate(headers, 1):
    ws_races.cell(row=3, column=col, value=header).font = Font(bold=True)

# 15 gare campione
places = ['Milano, MI', 'Roma, RM']
for i in range(15):
    title = f'Gara {i+1} - {"Campionato" if i%3==0 else "Tappa"}'
    place = places[i%2]
    km = random.randint(1,15)*100
    reg = random.randint(1,5)*20
    lodge = random.randint(1,5)*50 if i%4==0 else 0
    days = 2 if i%4==0 and random.random()<0.5 else 1.5 if i%4==0 else 1
    row = i + 4
    ws_races[f'A{row}'] = i+1
    ws_races[f'B{row}'] = title
    ws_races[f'C{row}'] = place
    ws_races[f'D{row}'] = km
    ws_races[f'E{row}'] = reg
    ws_races[f'F{row}'] = lodge
    ws_races[f'G{row}'] = days

# Totali gare (riga 18)
ws_races['D18'] = '=SUM(D4:D17)'
ws_races['E18'] = '=SUM(E4:E17)'
ws_races['F18'] = '=SUM(F4:F17)'
ws_races['G18'] = '=SUM(G4:G17)'

# Sheet Calcoli
ws_calc = wb.create_sheet('Calcoli')
ws_calc['A1'] = 'Dettaglio costi per voce'
ws_calc['A1'].font = Font(bold=True, size=14)

headers_calc = ['Voce di spesa', 'Categoria', 'Per gara (Media)', 'Stagione (Totale)']
for col, header in enumerate(headers_calc, 1):
    ws_calc.cell(row=3, column=col, value=header).font = Font(bold=True)

n_races = 15
ws_calc['A4'] = 'Leasing/Auto (annuo)'
ws_calc['B4'] = 'Logistica'
ws_calc['C4'] = f'=Inputs!B4*12 / {n_races}'
ws_calc['D4'] = '=Inputs!B4*12'

ws_calc['A5'] = 'Abbigliamento (annuo)'
ws_calc['B5'] = 'Manutenzione'
ws_calc['C5'] = f'=Inputs!B5 / {n_races}'
ws_calc['D5'] = '=Inputs!B5'

ws_calc['A6'] = 'Iscrizioni'
ws_calc['B6'] = 'Iscrizioni'
ws_calc['C6'] = f'=Gare!E18 / {n_races}'
ws_calc['D6'] = '=Gare!E18'

ws_calc['A7'] = 'Alloggio'
ws_calc['B7'] = 'Trasferte'
ws_calc['C7'] = f'=Gare!F18 / {n_races}'
ws_calc['D7'] = '=Gare!F18'

ws_calc['A8'] = 'Carburante'
ws_calc['B8'] = 'Trasferte'
ws_calc['C8'] = '=(Inputs!B9/100 * Inputs!B8 * Gare!D18 * Inputs!B11) / ' + str(n_races)
ws_calc['D8'] = '=(Inputs!B9/100 * Inputs!B8 * Gare!D18 * Inputs!B11)'

ws_calc['A9'] = 'Pedaggi'
ws_calc['B9'] = 'Trasferte'
ws_calc['C9'] = f'=Inputs!B10 * Gare!D18 * Inputs!B11 / {n_races}'
ws_calc['D9'] = '=Inputs!B10 * Gare!D18 * Inputs!B11'

ws_calc['A10'] = 'Totale spese'
ws_calc['A10'].font = Font(bold=True)
ws_calc['D10'] = '=SUM(D4:D9)'

# Sheet Riepilogo
ws_summary = wb.create_sheet('Riepilogo')
ws_summary['A1'] = 'Riepilogo Budget Stagionale'
ws_summary['A1'].font = Font(bold=True, size=16)

summary_items = [
    ('Budget stagionale totale', '=Calcoli!D10'),
    ('Spesa media per gara', f'=Calcoli!D10 / {n_races}'),
    ('Km totali viaggio', '=Gare!D18'),
    ('Giornate in trasferta', '=Gare!G18')
]

for idx, (label, formula) in enumerate(summary_items, 2):
    ws_summary[f'A{idx}'] = label
    ws_summary[f'B{idx}'] = formula
    ws_summary[f'B{idx}'].font = Font(size=14, bold=True)
    if '€' in label:
        ws_summary[f'B{idx}'].number_format = '€#,##0'
    else:
        ws_summary[f'B{idx}'].number_format = '#,##0.0'

# Salva
wb.save('budget_stagionale.xlsx')
print("File Excel generato: budget_stagionale.xlsx")
